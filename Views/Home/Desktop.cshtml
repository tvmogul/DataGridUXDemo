@{
    ViewData["Title"] = "JQuery DataTable Demo";
    var scriptNonce = Html.ScriptNonce();
}

<link rel="stylesheet" href="~/css/demo.css" />

<div style="margin-top: 0px !important; display: flex; justify-content: center; align-items: center;">
    <div style="position: relative; max-width: 800px; width: 100%; text-align: center;">
        <canvas id="netcanvas" width="800" height="70"
                style="display: block; width: 100%; height: 70px; border: none transparent;">
        </canvas>
        <div class="table-block" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); text-align: center;">
            <table style="margin: 0 auto;">
                <tr>
                    <td style="text-align: left !important;">
                        <h2 style="font-size: 1.8em; margin-bottom: 0px; white-space: nowrap;">
                            @ViewData["Title"]
                        </h2>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</div>

<div id="viewportInfo" style="text-align:center;font-size:12px;margin-bottom:6px;">
    Viewport: <span id="vw"></span> px
</div>

<div class="d-flex align-items-center gap-2 p-1 border rounded mx-auto"
     style="width: 80%;">

    <button id="themeToggle"
            class="btn btn-outline-secondary btn-sm">
        🌙 Dark Mode
    </button>

    <button id="toggleTableHeaderTheme"
            type="button"
            class="btn btn-sm btn-outline-secondary">
        Toggle Table Header Theme
    </button>

</div>

<br />

<div id="stationsTableHost">
    <table id="stationsTable" class="display stripe hover dt-header-light" style="width:100%">
        <thead>
            <tr>
                <th>
                    call<br />sign
                </th>
                <th>media<br />type</th>
                <th draggable="true">
                    aff1
                    <span class="drag-indicator">≡</span>
                </th>
                <th draggable="true">
                    city
                    <span class="drag-indicator">≡</span>
                </th>
                <th draggable="true">
                    region
                    <span class="drag-indicator">≡</span>
                </th>
                <th draggable="true">country</th>
                <th draggable="true">Min<br />Media</th>
                <th draggable="true">Max<br />Media</th>
                <th draggable="true">Max<br />Pay</th>
                <th draggable="true">Rank<br />Buys</th>
                <th draggable="true">Rank<br />Orders</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>KERO</td>
                <td>TVH</td>
                <td>CBS</td>
                <td>Bakersfield</td>
                <td>CA</td>
                <td>USA</td>
                <td>125</td>
                <td>635</td>
                <td>371</td>
                <td>195</td>
                <td>294</td>
            </tr>
            <tr>
                <td>KABC</td>
                <td>TVH</td>
                <td>ABC</td>
                <td>Los Angeles</td>
                <td>CA</td>
                <td>USA</td>
                <td>450</td>
                <td>2200</td>
                <td>1650</td>
                <td>12</td>
                <td>18</td>
            </tr>
            <tr>
                <td>KCBS</td>
                <td>TVH</td>
                <td>CBS</td>
                <td>Los Angeles</td>
                <td>CA</td>
                <td>USA</td>
                <td>480</td>
                <td>2400</td>
                <td>1800</td>
                <td>9</td>
                <td>14</td>
            </tr>
            <tr>
                <td>KNBC</td>
                <td>TVH</td>
                <td>NBC</td>
                <td>Los Angeles</td>
                <td>CA</td>
                <td>USA</td>
                <td>470</td>
                <td>2350</td>
                <td>1750</td>
                <td>11</td>
                <td>16</td>
            </tr>
            <tr>
                <td>KFOX</td>
                <td>TVH</td>
                <td>FOX</td>
                <td>Los Angeles</td>
                <td>CA</td>
                <td>USA</td>
                <td>420</td>
                <td>2100</td>
                <td>1550</td>
                <td>15</td>
                <td>21</td>
            </tr>
            <tr>
                <td>WABC</td>
                <td>TVH</td>
                <td>ABC</td>
                <td>New York</td>
                <td>NY</td>
                <td>USA</td>
                <td>520</td>
                <td>2600</td>
                <td>1950</td>
                <td>6</td>
                <td>9</td>
            </tr>
            <tr>
                <td>WCBS</td>
                <td>TVH</td>
                <td>CBS</td>
                <td>New York</td>
                <td>NY</td>
                <td>USA</td>
                <td>540</td>
                <td>2750</td>
                <td>2050</td>
                <td>5</td>
                <td>8</td>
            </tr>
            <tr>
                <td>WNBC</td>
                <td>TVH</td>
                <td>NBC</td>
                <td>New York</td>
                <td>NY</td>
                <td>USA</td>
                <td>535</td>
                <td>2700</td>
                <td>2000</td>
                <td>7</td>
                <td>10</td>
            </tr>
            <tr>
                <td>WNYW</td>
                <td>TVH</td>
                <td>FOX</td>
                <td>New York</td>
                <td>NY</td>
                <td>USA</td>
                <td>500</td>
                <td>2550</td>
                <td>1900</td>
                <td>10</td>
                <td>15</td>
            </tr>
            <tr>
                <td>WLS</td>
                <td>TVH</td>
                <td>ABC</td>
                <td>Chicago</td>
                <td>IL</td>
                <td>USA</td>
                <td>360</td>
                <td>1850</td>
                <td>1350</td>
                <td>22</td>
                <td>31</td>
            </tr>
            <tr>
                <td>WBBM</td>
                <td>TVH</td>
                <td>CBS</td>
                <td>Chicago</td>
                <td>IL</td>
                <td>USA</td>
                <td>370</td>
                <td>1900</td>
                <td>1400</td>
                <td>20</td>
                <td>28</td>
            </tr>
            <tr>
                <td>WMAQ</td>
                <td>TVH</td>
                <td>NBC</td>
                <td>Chicago</td>
                <td>IL</td>
                <td>USA</td>
                <td>365</td>
                <td>1880</td>
                <td>1380</td>
                <td>21</td>
                <td>29</td>
            </tr>
        </tbody>
    </table>
</div>

<hr />

<h3>Selected Row Values</h3>

<div class="compact-line">
    <label>Callsign:</label><input id="callsignTextBox" />
    <label>Aff1:</label><input id="aff1TextBox" />
    <label>Media:</label><input id="mediatypeTextBox" />
    <label>Min M:</label><input id="minMGrossTextBox" />
    <label>Max M:</label><input id="maxMGrossTextBox" />
    <label>Max Pay:</label><input id="maxPayTextBox" />
    <label>RB:</label><input id="buysRankTextBox" />
    <label>RO:</label><input id="callsRankTextBox" />
</div>

<!-- Group Bar (placeholder for drag-to-group) -->
<div id="groupZone" class="drop-zone">
    Drag column headers here to group
</div>

<!-- Group Legend (placeholder for Legend) -->
<div id="groupLegend" class="group-legend">
    <span class="legend-item">
        <span class="legend-icon">≡</span>
        groups
    </span>
    <span class="legend-item">
        <span class="legend-icon">▲▼</span>
        sort
    </span>
</div>

<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />


@section Scripts {

    <script nonce="@scriptNonce">
        // Disable groups.js auto-init so this view explicitly initializes the instance (injectable selectors/config)
        window.GroupedDT_CONFIG = window.GroupedDT_CONFIG || {};
        window.GroupedDT_CONFIG.autoInit = false;
    </script>

    <script src="/js/groups.js" nonce="@scriptNonce"></script>

    <script nonce="@scriptNonce">
        (function () {

            function boot() {

                // BUILD THE GRID (DataTable) IN THE VIEW
                var table = $('#stationsTable').DataTable({
                    dom: '<"dt-top-row"l<"group-zone-holder"><"dt-spacer">f>rtip',
                    paging: true,
                    searching: true,
                    info: true,
                    order: [],
                    columnDefs: [
                        // Center text columns
                        { targets: [0, 1, 2, 4, 5], className: 'dt-center' },

                        // Right-align numeric columns
                        { targets: [6, 7, 8, 9, 10], className: 'dt-right' },

                        //Left-align numeric columns
                        { targets: [3], className: 'dt-left' }
                    ]
                });

                setTimeout(function () {
                    table.columns.adjust().draw(false);
                }, 0);

                // GROUPS ONLY (groups.js)
                if (window.GroupedDT && typeof window.GroupedDT.init === "function") {
                    window.GroupedDT.init({
                        tableSelector: "#stationsTable",
                        groupZoneSelector: "#groupZone",
                        groupLegendSelector: "#groupLegend"
                    });
                }

                // ROW SELECTION + TEXTBOX FILLING (VIEW ONLY)
                $('#stationsTable tbody').off('click.rowSelect').on('click.rowSelect', 'tr:not(.group-row)', function () {

                    if (!table.data().any()) return;

                    var rowData = table.row(this).data();
                    if (!rowData) return;

                    $('#callsignTextBox').val(rowData[0]);
                    $('#aff1TextBox').val(rowData[2] || '');
                    $('#mediatypeTextBox').val(rowData[1] || '');
                    $('#minMGrossTextBox').val(rowData[6] || '');
                    $('#maxMGrossTextBox').val(rowData[7] || '');
                    $('#maxPayTextBox').val(rowData[8] || '');
                    $('#buysRankTextBox').val(rowData[9] || '');
                    $('#callsRankTextBox').val(rowData[10] || '');

                    $('#stationsTable tbody tr').removeClass('selected');
                    $(this).addClass('selected');
                });

                // Header theme toggle (VIEW ONLY)
                (function initHeaderThemeToggle() {
                    const tableEl = document.getElementById("stationsTable");
                    const btn = document.getElementById("toggleTableHeaderTheme");
                    if (!tableEl || !btn) return;

                    btn.addEventListener("click", function () {
                        if (tableEl.classList.contains("dt-header-dark")) {
                            tableEl.classList.remove("dt-header-dark");
                            tableEl.classList.add("dt-header-light");
                        } else {
                            tableEl.classList.remove("dt-header-light");
                            tableEl.classList.add("dt-header-dark");
                        }
                    });
                })();

                // Theme toggle (VIEW ONLY)
                (function initThemeToggle() {
                    const themeToggle = document.getElementById('themeToggle');
                    if (!themeToggle) return;

                    const currentTheme = localStorage.getItem('theme') || 'light';
                    applyTheme(currentTheme);

                    themeToggle.addEventListener('click', function () {
                        const newTheme = (document.body.classList.contains('dark-theme')) ? 'light' : 'dark';
                        applyTheme(newTheme);
                        localStorage.setItem('theme', newTheme);
                    });

                    function applyTheme(theme) {
                        if (theme === 'dark') {
                            document.body.classList.remove('light-theme');
                            document.body.classList.add('dark-theme');
                            document.documentElement.setAttribute('data-bs-theme', 'dark');
                            themeToggle.textContent = '☀️ Light Mode';
                        } else {
                            document.body.classList.remove('dark-theme');
                            document.body.classList.add('light-theme');
                            document.documentElement.setAttribute('data-bs-theme', 'light');
                            themeToggle.textContent = '🌙 Dark Mode';
                        }
                    }
                })();

                // Viewport width (VIEW ONLY)
                (function initViewportWidth() {
                    function updateViewportWidth() {
                        var el = document.getElementById("vw");
                        if (!el) return;
                        el.textContent = window.innerWidth;
                    }

                    window.removeEventListener("resize", updateViewportWidth);
                    window.addEventListener("resize", updateViewportWidth);
                    updateViewportWidth();
                })();

                // ✅ Ensure global theme is applied on this view based on saved preference (VIEW ONLY)
                (function initGlobalTheme() {
                    try {
                        const savedTheme = localStorage.getItem('theme') || 'light';

                        if (savedTheme === 'dark') {
                            document.body.classList.remove('light-theme');
                            document.body.classList.add('dark-theme');
                            document.documentElement.setAttribute('data-bs-theme', 'dark');
                        } else {
                            document.body.classList.remove('dark-theme');
                            document.body.classList.add('light-theme');
                            document.documentElement.setAttribute('data-bs-theme', 'light');
                        }
                    } catch (e) {
                        console.warn('Theme init failed on Welcome view:', e);
                    }
                })();

            }

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", boot);
            } else {
                boot();
            }

        })();
    </script>

}
