@{
    // Html.RenderPartial("_jwt_token_check");
    ViewData["Title"] = "JQuery DataTable Demo";
    var scriptNonce = Html.ScriptNonce();
    //var styleNonce = Html.StyleNonce();
}

<div style="margin-top: 0px !important; display: flex; justify-content: center; align-items: center;">
    <div style="position: relative; max-width: 800px; width: 100%; text-align: center;">
        <canvas id="netcanvas" width="800" height="70"
                style="display: block; width: 100%; height: 70px; border: none transparent;">
        </canvas>
        <div class="table-block" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); text-align: center;">
            <table style="margin: 0 auto;">
                <tr>
                    @* <td style="text-align: right !important;">
                        <img src="/img/title_tv.gif" alt="Settings"
                                style="height: 70px; vertical-align: top; margin-top: -22px; margin-right: 4px;">
                    </td> *@
                    <td style="text-align: left !important;">
                        <h2 style="font-size: 1.8em; margin-bottom: 0px; white-space: nowrap;">
                            @ViewData["Title"]
                        </h2>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</div>

<div id="viewportInfo" style="text-align:center;font-size:12px;margin-bottom:6px;">
    Viewport: <span id="vw"></span> px
</div>

<!-- Group Bar (placeholder for future drag-to-group logic) -->
<div id="groupZone" class="drop-zone">
    Drag column headers here to group
</div>

<div class="d-flex align-items-center gap-2 p-1 border rounded mx-auto"
     style="width: 80%;">

    <button id="themeToggle"
            class="btn btn-outline-secondary btn-sm">
        🌙 Dark Mode
    </button>

    <button id="toggleTableHeaderTheme"
            type="button"
            class="btn btn-sm btn-outline-secondary">
        Toggle Table Header Theme
    </button>

</div>

<br />

<div id="stationsTableHost">
    <table id="stationsTable" class="display stripe hover dt-header-light" style="width:100%">
        <thead>
            <tr>
                <th>callsign</th>
                <th>media<br />type</th>
                <th draggable="true">
                    aff1
                    <span class="drag-indicator">≡</span>
                </th>
                <th draggable="true">
                    city
                    <span class="drag-indicator">≡</span>
                </th>
                <th draggable="true">
                    region
                    <span class="drag-indicator">≡</span>
                </th>
                <th draggable="true">country</th>
                <th draggable="true">Min<br />Media</th>
                <th draggable="true">Max<br />Media</th>
                <th draggable="true">Max<br />Pay</th>
                <th draggable="true">Rank<br />Buys</th>
                <th draggable="true">Rank<br />Orders</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>KERO</td>
                <td>TVH</td>
                <td>CBS</td>
                <td>Bakersfield</td>
                <td>CA</td>
                <td>USA</td>
                <td>125</td>
                <td>635</td>
                <td>371</td>
                <td>195</td>
                <td>294</td>
            </tr>
            <tr>
                <td>KABC</td>
                <td>TVH</td>
                <td>ABC</td>
                <td>Los Angeles</td>
                <td>CA</td>
                <td>USA</td>
                <td>450</td>
                <td>2200</td>
                <td>1650</td>
                <td>12</td>
                <td>18</td>
            </tr>
            <tr>
                <td>KCBS</td>
                <td>TVH</td>
                <td>CBS</td>
                <td>Los Angeles</td>
                <td>CA</td>
                <td>USA</td>
                <td>480</td>
                <td>2400</td>
                <td>1800</td>
                <td>9</td>
                <td>14</td>
            </tr>
            <tr>
                <td>KNBC</td>
                <td>TVH</td>
                <td>NBC</td>
                <td>Los Angeles</td>
                <td>CA</td>
                <td>USA</td>
                <td>470</td>
                <td>2350</td>
                <td>1750</td>
                <td>11</td>
                <td>16</td>
            </tr>
            <tr>
                <td>KFOX</td>
                <td>TVH</td>
                <td>FOX</td>
                <td>Los Angeles</td>
                <td>CA</td>
                <td>USA</td>
                <td>420</td>
                <td>2100</td>
                <td>1550</td>
                <td>15</td>
                <td>21</td>
            </tr>
            <tr>
                <td>WABC</td>
                <td>TVH</td>
                <td>ABC</td>
                <td>New York</td>
                <td>NY</td>
                <td>USA</td>
                <td>520</td>
                <td>2600</td>
                <td>1950</td>
                <td>6</td>
                <td>9</td>
            </tr>
            <tr>
                <td>WCBS</td>
                <td>TVH</td>
                <td>CBS</td>
                <td>New York</td>
                <td>NY</td>
                <td>USA</td>
                <td>540</td>
                <td>2750</td>
                <td>2050</td>
                <td>5</td>
                <td>8</td>
            </tr>
            <tr>
                <td>WNBC</td>
                <td>TVH</td>
                <td>NBC</td>
                <td>New York</td>
                <td>NY</td>
                <td>USA</td>
                <td>535</td>
                <td>2700</td>
                <td>2000</td>
                <td>7</td>
                <td>10</td>
            </tr>
            <tr>
                <td>WNYW</td>
                <td>TVH</td>
                <td>FOX</td>
                <td>New York</td>
                <td>NY</td>
                <td>USA</td>
                <td>500</td>
                <td>2550</td>
                <td>1900</td>
                <td>10</td>
                <td>15</td>
            </tr>
            <tr>
                <td>WLS</td>
                <td>TVH</td>
                <td>ABC</td>
                <td>Chicago</td>
                <td>IL</td>
                <td>USA</td>
                <td>360</td>
                <td>1850</td>
                <td>1350</td>
                <td>22</td>
                <td>31</td>
            </tr>
            <tr>
                <td>WBBM</td>
                <td>TVH</td>
                <td>CBS</td>
                <td>Chicago</td>
                <td>IL</td>
                <td>USA</td>
                <td>370</td>
                <td>1900</td>
                <td>1400</td>
                <td>20</td>
                <td>28</td>
            </tr>
            <tr>
                <td>WMAQ</td>
                <td>TVH</td>
                <td>NBC</td>
                <td>Chicago</td>
                <td>IL</td>
                <td>USA</td>
                <td>365</td>
                <td>1880</td>
                <td>1380</td>
                <td>21</td>
                <td>29</td>
            </tr>
        </tbody>
    </table>
</div>

<hr />

<h3>Selected Row Values</h3>

<div class="compact-line">
    <label>Callsign:</label><input id="callsignTextBox" />
    <label>Aff1:</label><input id="aff1TextBox" />
    <label>Media:</label><input id="mediatypeTextBox" />
    <label>Min M:</label><input id="minMGrossTextBox" />
    <label>Max M:</label><input id="maxMGrossTextBox" />
    <label>Max Pay:</label><input id="maxPayTextBox" />
    <label>RB:</label><input id="buysRankTextBox" />
    <label>RO:</label><input id="callsRankTextBox" />
</div>

<div id="groupLegend" class="group-legend">
    <span class="legend-item">
        <span class="legend-icon">≡</span>
        groups
    </span>
    <span class="legend-item">
        <span class="legend-icon">▲▼</span>
        sort
    </span>
</div>

<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />

@section Scripts {

    <script nonce="@scriptNonce">

        function isMobileDeviceForDemo() {
            try {
                var touch = (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
                var coarse = (window.matchMedia && window.matchMedia('(pointer: coarse)').matches);
                return (touch && coarse);
            } catch (e) {
                return false;
            }
        }

        document.addEventListener("DOMContentLoaded", function () {

            var isMobile = isMobileDeviceForDemo();

            if (isMobile) {
                return;
            }

            var groupedColumnIndex = null;

            var table = $('#stationsTable').DataTable({
                dom: '<"dt-top-row"l<"group-zone-holder"><"dt-spacer">f>rtip',
                paging: true,
                searching: true,
                info: true,
                order: [],
                columnDefs: [
                    { targets: [0, 1, 2, 4, 5], className: 'dt-center' },
                    { targets: [6, 7, 8, 9, 10], className: 'dt-right' },
                    { targets: [3], className: 'dt-left' }
                ],
                drawCallback: function () {
                    if (groupedColumnIndex === null) return;
                    var api = this.api();
                    var rows = api.rows({ page: 'current' }).nodes();
                    var last = null;

                    api.column(groupedColumnIndex, { page: 'current' }).data().each(function (group, i) {
                        if (last !== group) {
                            $(rows).eq(i).before(
                                '<tr class="group-row" data-group="' + group + '">' +
                                '<td colspan="8"><span class="group-toggle">+</span> ' + group + '</td>' +
                                '</tr>'
                            );
                            last = group;
                        }
                    });

                    $('#stationsTable tbody tr:not(.group-row)').hide();
                }
            });

            setTimeout(function () {
                table.columns.adjust().draw(false);
            }, 0);

            $('#groupZone').appendTo('.group-zone-holder');
            $('#groupLegend').appendTo('.group-zone-holder');

            $('#stationsTable tbody').on('click', 'tr.group-row', function () {
                var group = $(this).data('group');
                var isOpen = $(this).hasClass('open');

                $(this).toggleClass('open');
                $(this).find('.group-toggle').text(isOpen ? '+' : '−');

                $('#stationsTable tbody tr').each(function () {
                    var rowData = table.row(this).data();
                    if (!rowData) return;
                    if (rowData[groupedColumnIndex] === group) {
                        $(this).toggle(!isOpen);
                    }
                });
            });

            $('#stationsTable tbody').on('click', 'tr:not(.group-row)', function () {
                var rowData = table.row(this).data();
                if (!rowData) return;

                $('#callsignTextBox').val(rowData[0]);
                $('#aff1TextBox').val(rowData[1]);
                $('#mediatypeTextBox').val(rowData[2]);
                $('#minMGrossTextBox').val(rowData[3]);
                $('#maxMGrossTextBox').val(rowData[4]);
                $('#maxPayTextBox').val(rowData[5]);
                $('#buysRankTextBox').val(rowData[6]);
                $('#callsRankTextBox').val(rowData[7]);

                $('#stationsTable tbody tr').removeClass('selected');
                $(this).addClass('selected');
            });

            $('#stationsTable thead th').on('dragstart', function (e) {
                e.originalEvent.dataTransfer.setData('colIndex', $(this).index());
                e.originalEvent.dataTransfer.setData('colName', $(this).text());
            });

            $('#groupZone').on('dragover', function (e) {
                e.preventDefault();
            });

            $('#groupZone').on('drop', function (e) {
                e.preventDefault();
                groupedColumnIndex = parseInt(e.originalEvent.dataTransfer.getData('colIndex'));
                var colName = e.originalEvent.dataTransfer.getData('colName');

                $('#groupZone').html(
                    '<strong>Grouped By:</strong> ' +
                    '<span class="group-pill">' + colName +
                    ' <span class="remove-group">✕</span></span>'
                );

                table.order([groupedColumnIndex, 'asc']).draw();
            });

            $('#groupZone').on('click', '.remove-group', function () {
                groupedColumnIndex = null;
                $('#groupZone').html('Drag column headers here to group').attr('class', 'drop-zone');
                $('#stationsTable tbody tr').show();
                table.order([]).draw();
            });
        });

    </script>

    <script nonce="@scriptNonce">
        function updateViewportWidth() {
            document.getElementById("vw").textContent = window.innerWidth;
        }
        window.addEventListener("resize", updateViewportWidth);
        document.addEventListener("DOMContentLoaded", updateViewportWidth);
    </script>

}

<style>
    html, body {
        max-width: 100%;
        overflow-x: hidden;
    }

    #stationsTable {
        width: 100% !important;
    }
</style>
