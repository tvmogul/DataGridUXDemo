@{
    ViewData["Title"] = "JQuery DataTable Demo";
    var scriptNonce = Html.ScriptNonce();
}

<link rel="stylesheet" href="~/css/groups.css" />

<div style="margin-top: 0px !important; display: flex; justify-content: center; align-items: center;">
    <div style="position: relative; max-width: 800px; width: 100%; text-align: center;">
        <canvas id="netcanvas" width="800" height="70"
                style="display: block; width: 100%; height: 70px; border: none transparent;">
        </canvas>
        <div class="table-block" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); text-align: center;">
            <table style="margin: 0 auto;">
                <tr>
                    <td style="text-align: left !important;">
                        <h2 style="font-size: 1.8em; margin-bottom: 0px; white-space: nowrap;">
                            @ViewData["Title"]
                        </h2>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</div>

<div id="viewportInfo" style="text-align:center;font-size:12px;margin-bottom:6px;">
    Viewport: <span id="vw"></span> px
</div>

<div class="d-flex align-items-center gap-2 p-1 border rounded mx-auto"
     style="width: 80%;">

    <button id="themeToggle"
            class="btn btn-outline-secondary btn-sm">
        🌙 Dark Mode
    </button>

    <button id="toggleTableHeaderTheme"
            type="button"
            class="btn btn-sm btn-outline-secondary">
        Toggle Table Header Theme
    </button>

</div>

<br />

<div id="stationsTableHost">
    <table id="stationsTable" class="display stripe hover dt-header-light" style="width:100%">
        <thead>
            <tr>
                <th>
                    call<br />sign
                </th>
                <th>media<br />type</th>
                <th draggable="true">
                    aff1
                    <span class="drag-indicator">≡</span>
                </th>
                <th draggable="true">
                    city
                    <span class="drag-indicator">≡</span>
                </th>
                <th draggable="true">
                    region
                    <span class="drag-indicator">≡</span>
                </th>
                <th draggable="true">country</th>
                <th draggable="true">Min<br />Media</th>
                <th draggable="true">Max<br />Media</th>
                <th draggable="true">Max<br />Pay</th>
                <th draggable="true">Rank<br />Buys</th>
                <th draggable="true">Rank<br />Orders</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<hr />

<h3>Selected Row Values</h3>

<div class="compact-line">
    <label>Callsign:</label><input id="callsignTextBox" />
    <label>Aff1:</label><input id="aff1TextBox" />
    <label>Media:</label><input id="mediatypeTextBox" />
    <label>Min M:</label><input id="minMGrossTextBox" />
    <label>Max M:</label><input id="maxMGrossTextBox" />
    <label>Max Pay:</label><input id="maxPayTextBox" />
    <label>RB:</label><input id="buysRankTextBox" />
    <label>RO:</label><input id="callsRankTextBox" />
</div>

<!-- Group Bar (placeholder for drag-to-group) -->
<div id="groupZone" class="drop-zone groupeddt-hidden">
    Drag column headers here to group
</div>

<!-- Group Legend (placeholder for Legend) -->
<div id="groupLegend" class="group-legend groupeddt-hidden">
    <span class="legend-item">
        <span class="legend-icon">≡</span>
        groups
    </span>
    <span class="legend-item">
        <span class="legend-icon">▲▼</span>
        sort
    </span>
</div>

<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />


@section Scripts {

    <script src="/js/groups.js" nonce="@scriptNonce"></script>

    <script nonce="@scriptNonce">

        $('#groupZone, #groupLegend').removeClass('groupeddt-hidden');
        // $('#groupZone, #groupLegend').addClass('groupeddt-hidden');

        var table1 = null;

        // DATA SOURCE FOR GRID (VIEW ONLY)
        var stationsData = [
            ["KERO", "TVH", "CBS", "Bakersfield", "CA", "USA", 125, 635, 371, 195, 294],
            ["KABC", "TVH", "ABC", "Los Angeles", "CA", "USA", 450, 2200, 1650, 12, 18],
            ["KCBS", "TVH", "CBS", "Los Angeles", "CA", "USA", 480, 2400, 1800, 9, 14],
            ["KNBC", "TVH", "NBC", "Los Angeles", "CA", "USA", 470, 2350, 1750, 11, 16],
            ["KFOX", "TVH", "FOX", "Los Angeles", "CA", "USA", 420, 2100, 1550, 15, 21],
            ["WABC", "TVH", "ABC", "New York", "NY", "USA", 520, 2600, 1950, 6, 9],
            ["WCBS", "TVH", "CBS", "New York", "NY", "USA", 540, 2750, 2050, 5, 8],
            ["WNBC", "TVH", "NBC", "New York", "NY", "USA", 535, 2700, 2000, 7, 10],
            ["WNYW", "TVH", "FOX", "New York", "NY", "USA", 500, 2550, 1900, 10, 15],
            ["WLS", "TVH", "ABC", "Chicago", "IL", "USA", 360, 1850, 1350, 22, 31],
            ["WBBM", "TVH", "CBS", "Chicago", "IL", "USA", 370, 1900, 1400, 20, 28],
            ["WMAQ", "TVH", "NBC", "Chicago", "IL", "USA", 365, 1880, 1380, 21, 29]
        ];

        // ==============================================
        // ROW SELECTION + TEXTBOX FILLING (VIEW ONLY)
        // ==============================================
        (function initRowSelectionOnly() {

            function bindRowSelectionOnly() {

                var $tbody = $('#stationsTable tbody');

                $tbody.off('click.rowSelect touchstart.rowSelect')
                      .on('click.rowSelect touchstart.rowSelect', 'tr', function (e) {

                          var $tr = $(this);

                          // Ignore group rows entirely (row selection is independent)
                          if ($tr.hasClass('group-row')) return;

                          // Only run if DataTable is already initialized (avoid accidental auto-init)
                          if (!$.fn.dataTable || !$.fn.dataTable.isDataTable || !$.fn.dataTable.isDataTable('#stationsTable')) return;

                          var dt = $('#stationsTable').DataTable();

                          if (!dt.data().any()) return;

                          var rowData = dt.row(this).data();
                          if (!rowData) return;

                          $('#callsignTextBox').val(rowData[0]);
                          $('#aff1TextBox').val(rowData[2] || '');
                          $('#mediatypeTextBox').val(rowData[1] || '');
                          $('#minMGrossTextBox').val(rowData[6] || '');
                          $('#maxMGrossTextBox').val(rowData[7] || '');
                          $('#maxPayTextBox').val(rowData[8] || '');
                          $('#buysRankTextBox').val(rowData[9] || '');
                          $('#callsRankTextBox').val(rowData[10] || '');

                          // Limit selection clearing to the DataTable's rows
                          try {
                              dt.$('tbody tr').removeClass('selected');
                          } catch (ex) {
                              $('#stationsTable tbody tr').removeClass('selected');
                          }

                          $tr.addClass('selected');

                          if (e && e.type === 'touchstart') {
                              e.preventDefault();
                              e.stopPropagation();
                              return false;
                          }
                      });
            }

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", bindRowSelectionOnly);
            } else {
                bindRowSelectionOnly();
            }

        })();

        // Header theme toggle (VIEW ONLY)
        (function initHeaderThemeToggle() {
            const tableEl = document.getElementById("stationsTable");
            const btn = document.getElementById("toggleTableHeaderTheme");
            if (!tableEl || !btn) return;

            btn.addEventListener("click", function () {
                if (tableEl.classList.contains("dt-header-dark")) {
                    tableEl.classList.remove("dt-header-dark");
                    tableEl.classList.add("dt-header-light");
                } else {
                    tableEl.classList.remove("dt-header-light");
                    tableEl.classList.add("dt-header-dark");
                }
            });
        })();

        // Theme toggle (VIEW ONLY)
        (function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            if (!themeToggle) return;

            const currentTheme = localStorage.getItem('theme') || 'light';
            applyTheme(currentTheme);

            themeToggle.addEventListener('click', function () {
                const newTheme = (document.body.classList.contains('dark-theme')) ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.remove('light-theme');
                    document.body.classList.add('dark-theme');
                    document.documentElement.setAttribute('data-bs-theme', 'dark');
                    themeToggle.textContent = '☀️ Light Mode';
                } else {
                    document.body.classList.remove('dark-theme');
                    document.body.classList.add('light-theme');
                    document.documentElement.setAttribute('data-bs-theme', 'light');
                    themeToggle.textContent = '🌙 Dark Mode';
                }
            }
        })();

        // Viewport width (VIEW ONLY)
        (function initViewportWidth() {
            function updateViewportWidth() {
                var el = document.getElementById("vw");
                if (!el) return;
                el.textContent = window.innerWidth;
            }

            window.removeEventListener("resize", updateViewportWidth);
            window.addEventListener("resize", updateViewportWidth);
            updateViewportWidth();
        })();

        // ✅ Ensure global theme is applied on this view based on saved preference (VIEW ONLY)
        (function initGlobalTheme() {
            try {
                const savedTheme = localStorage.getItem('theme') || 'light';

                if (savedTheme === 'dark') {
                    document.body.classList.remove('light-theme');
                    document.body.classList.add('dark-theme');
                    document.documentElement.setAttribute('data-bs-theme', 'dark');
                } else {
                    document.body.classList.remove('dark-theme');
                    document.body.classList.add('light-theme');
                    document.documentElement.setAttribute('data-bs-theme', 'light');
                }
            } catch (e) {
                console.warn('Theme init failed on Welcome view:', e);
            }
        })();

        (function () {

            function boot() {

                // BUILD THE GRID (DataTable) IN THE VIEW
                table1 = $('#stationsTable').DataTable({
                    dom: '<"dt-top-row"l<"group-zone-holder"><"dt-spacer">f>rtip',
                    data: stationsData,
                    paging: true,
                    searching: true,
                    info: true,
                    order: [],
                    columnDefs: [
                        // Center text columns
                        { targets: [0, 1, 2, 4, 5], className: 'dt-center' },

                        // Right-align numeric columns
                        { targets: [6, 7, 8, 9, 10], className: 'dt-right' },

                        //Left-align numeric columns
                        { targets: [3], className: 'dt-left' }
                    ]
                });

                setTimeout(function () {
                    table1.columns.adjust().draw(false);
                }, 0);

                // GROUPS ONLY (groups.js)
                if (window.GroupedDT && typeof window.GroupedDT.init === "function") {
                    window.GroupedDT.init({
                        tableSelector: "#stationsTable",
                        groupZoneSelector: "#groupZone",
                        groupLegendSelector: "#groupLegend"
                    });
                }

            }

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", boot);
            } else {
                boot();
            }

        })();
    </script>

}

<style>

/*     .groupeddt-hidden {
        display: none !important;
    } */

</style>